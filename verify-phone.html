<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Verify Phone â€” Angels Hair Mall</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<style>
body {
  font-family: Inter, system-ui, sans-serif;
  max-width: 480px;
  margin: 80px auto;
  padding: 0 20px;
}
h1 { font-size: 28px; margin-bottom: 10px; }
p { color:#444; line-height:1.6; }

.row {
  display:flex;
  gap:10px;
  margin-top:14px;
}

select, input {
  padding:14px;
  border:1px solid #000;
  font-size:14px;
}

select {
  width:38%;
}

input {
  flex:1;
}

button {
  margin-top:18px;
  padding:14px;
  width:100%;
  border:1px solid #000;
  background:#000;
  color:#fff;
  cursor:pointer;
}
button:disabled { opacity:0.6; cursor:not-allowed; }

.msg { margin-top:14px; font-size:14px; }
.ok { color: green; }
</style>
</head>

<body>
<h1>Verify your phone number</h1>
<p>Weâ€™ll send you a one-time code by SMS. This only happens once.</p>

<div class="row">
  <select id="countryCode">
    <option value="+44">ðŸ‡¬ðŸ‡§ UK (+44)</option>
    <option value="+234">ðŸ‡³ðŸ‡¬ Nigeria (+234)</option>
    <option value="+1">ðŸ‡ºðŸ‡¸ USA (+1)</option>
    <option value="+33">ðŸ‡«ðŸ‡· France (+33)</option>
    <option value="+351">ðŸ‡µðŸ‡¹ Portugal (+351)</option>
    <option value="+34">ðŸ‡ªðŸ‡¸ Spain (+34)</option>
  </select>

  <input id="phone" placeholder="Phone number" />
</div>

<div id="recaptcha"></div>

<button id="sendCode">Send code</button>

<input id="code" placeholder="Enter SMS code" style="display:none" />
<button id="confirmCode" style="display:none">Confirm code</button>

<div class="msg" id="msg"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { 
  getAuth, 
  RecaptchaVerifier, 
  PhoneAuthProvider, 
  linkWithCredential, 
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAZ_6nBhOpzPBtYunilmDhcKd0Woe1PWYs",
  authDomain: "angelshairmall.firebaseapp.com",
  databaseURL: "https://angelshairmall-default-rtdb.firebaseio.com",
  projectId: "angelshairmall",
  messagingSenderId: "374317477500",
  appId: "1:374317477500:web:ba6aad4bfba04a9ae6e3f9"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const phoneInput = document.getElementById("phone");
const countryCode = document.getElementById("countryCode");
const sendBtn = document.getElementById("sendCode");
const codeInput = document.getElementById("code");
const confirmBtn = document.getElementById("confirmCode");
const msg = document.getElementById("msg");

// Block access if not logged in
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  // If already verified, don't let them redo it
  const snap = await get(ref(db, `users/${user.uid}`));
  if (snap.exists() && snap.val()?.phoneVerified === true) {
    window.location.href = "booking.html";
  }
});

window.recaptchaVerifier = new RecaptchaVerifier(auth, "recaptcha", {
  size: "normal"
});

let verificationId = null;

sendBtn.onclick = async () => {
  try {
    const fullNumber = countryCode.value + phoneInput.value.replace(/\s+/g, "");
    msg.textContent = "Sending code...";

    const provider = new PhoneAuthProvider(auth);
    verificationId = await provider.verifyPhoneNumber(fullNumber, window.recaptchaVerifier);

    codeInput.style.display = "block";
    confirmBtn.style.display = "block";
    msg.textContent = "Code sent! Check your SMS.";

  } catch (e) {
    msg.textContent = e.message.replace("Firebase:", "");
  }
};

confirmBtn.onclick = async () => {
  try {
    const user = auth.currentUser;
    if (!user) throw new Error("Not signed in.");

    const cred = PhoneAuthProvider.credential(verificationId, codeInput.value);
    await linkWithCredential(user, cred);

    const fullNumber = countryCode.value + phoneInput.value.replace(/\s+/g, "");

    await update(ref(db, `users/${user.uid}`), {
      phone: fullNumber,
      phoneVerified: true
    });

    msg.textContent = "Phone verified! Redirecting...";
    msg.classList.add("ok");

    setTimeout(() => {
      window.location.href = "booking.html";
    }, 1200);

  } catch (e) {
    msg.textContent = "Invalid code or number already linked.";
  }
};
</script>
</body>
</html>
